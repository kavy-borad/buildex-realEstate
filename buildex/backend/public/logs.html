<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Log Viewer - Buildex</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #F8FAFD;
            --card-bg: #FFFFFF;
            --border: #E8EDF3;
            --text-primary: #1A1D26;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --accent-blue: #3B82F6;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --accent-amber: #F59E0B;
            --pill-api-bg: #EEF2FF;
            --pill-api-text: #4F46E5;
            --pill-get-bg: #ECFDF5;
            --pill-get-text: #059669;
            --pill-get-border: #A7F3D0;
            --pill-post-bg: #EFF6FF;
            --pill-post-text: #2563EB;
            --pill-post-border: #BFDBFE;
            --pill-put-bg: #FFFBEB;
            --pill-put-text: #D97706;
            --pill-put-border: #FDE68A;
            --pill-delete-bg: #FEF2F2;
            --pill-delete-text: #DC2626;
            --pill-delete-border: #FECACA;
            --pill-patch-bg: #F5F3FF;
            --pill-patch-text: #7C3AED;
            --pill-patch-border: #DDD6FE;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 16px 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
        }

        .connection-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 12px;
        }

        .connection-badge.connected {
            background: #ECFDF5;
            color: #059669;
        }

        .connection-badge.disconnected {
            background: #FEF2F2;
            color: #DC2626;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: relative;
        }

        .connection-dot.online {
            background: #10B981;
        }

        .connection-dot.online::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            border: 2px solid #10B981;
            animation: pulse-ring 1.5s infinite;
        }

        .connection-dot.offline {
            background: #EF4444;
        }

        @keyframes pulse-ring {
            0% {
                opacity: 0.6;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(1.8);
            }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--card-bg);
            color: var(--text-secondary);
        }

        .btn:hover {
            background: #F3F4F6;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .btn-primary:hover {
            background: #2563EB;
        }

        .btn-primary.off {
            background: var(--card-bg);
            color: var(--text-secondary);
            border-color: var(--border);
        }

        .btn-clear {
            color: var(--accent-red);
            border-color: #FECACA;
        }

        .btn-clear:hover {
            background: #FEF2F2;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .tab-bar {
            display: flex;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            padding: 12px 24px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API TESTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .api-tester {
            padding: 24px 28px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .tester-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 14px;
        }

        .method-select {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            min-width: 100px;
        }

        .url-input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            font-family: 'Fira Code', monospace;
            color: var(--text-primary);
        }

        .url-input:focus,
        .method-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .send-btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            color: white;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            transition: all 0.15s;
            min-width: 100px;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .body-area {
            width: 100%;
            min-height: 120px;
            padding: 14px;
            border-radius: 8px;
            font-size: 12px;
            border: 1px solid var(--border);
            background: #FAFBFC;
            font-family: 'Fira Code', monospace;
            color: var(--text-primary);
            resize: vertical;
        }

        .body-area:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .body-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .response-preview {
            margin-top: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #F3F4F6;
            border-bottom: 1px solid var(--border);
        }

        .response-status {
            font-size: 12px;
            font-weight: 700;
            padding: 2px 10px;
            border-radius: 6px;
            color: white;
        }

        .response-time-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .response-body-preview {
            padding: 14px;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            background: white;
            max-height: 300px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--text-primary);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .stats-bar {
            display: flex;
            align-items: center;
            gap: 32px;
            padding: 14px 28px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .stat-item {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .stat-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
        }

        .stat-value.green {
            color: var(--accent-green);
        }

        .stat-value.red {
            color: var(--accent-red);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 28px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--card-bg);
            color: var(--text-secondary);
        }

        .filter-btn:hover {
            background: #F3F4F6;
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOG LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .log-list {
            padding: 0;
            flex: 1;
            overflow-y: auto;
        }

        .log-group {
            border-bottom: 1px solid var(--border);
        }

        .log-row {
            display: grid;
            grid-template-columns: 70px 65px 1fr 70px 70px 90px 30px;
            align-items: center;
            padding: 12px 28px;
            background: var(--card-bg);
            transition: background 0.1s ease;
            cursor: pointer;
            font-size: 13px;
        }

        .log-row:hover {
            background: #F9FAFB;
        }

        .log-row.error-row {
            background: #FFF5F5;
        }

        .log-row.error-row:hover {
            background: #FEF2F2;
        }

        .log-row.new-entry {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
                background: #EEF2FF;
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .log-details {
            display: none;
            background: #F9FAFB;
            padding: 16px 28px;
            border-top: 1px dashed var(--border);
        }

        .log-details.open {
            display: block;
        }

        .detail-section {
            margin-bottom: 16px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .code-block {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            color: var(--text-primary);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.3px;
            border: 1px solid;
        }

        .pill-api {
            background: var(--pill-api-bg);
            color: var(--pill-api-text);
            border-color: #C7D2FE;
        }

        .pill-get {
            background: var(--pill-get-bg);
            color: var(--pill-get-text);
            border-color: var(--pill-get-border);
        }

        .pill-post {
            background: var(--pill-post-bg);
            color: var(--pill-post-text);
            border-color: var(--pill-post-border);
        }

        .pill-put {
            background: var(--pill-put-bg);
            color: var(--pill-put-text);
            border-color: var(--pill-put-border);
        }

        .pill-delete {
            background: var(--pill-delete-bg);
            color: var(--pill-delete-text);
            border-color: var(--pill-delete-border);
        }

        .pill-patch {
            background: var(--pill-patch-bg);
            color: var(--pill-patch-text);
            border-color: var(--pill-patch-border);
        }

        .log-url {
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 16px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 38px;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }

        .status-2xx {
            background: #10B981;
        }

        .status-3xx {
            background: #3B82F6;
        }

        .status-4xx {
            background: #F59E0B;
        }

        .status-5xx {
            background: #EF4444;
        }

        .response-time {
            font-size: 12px;
            font-weight: 600;
            text-align: right;
        }

        .time-fast {
            color: #10B981;
        }

        .time-medium {
            color: #F59E0B;
        }

        .time-slow {
            color: #EF4444;
        }

        .timestamp {
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .expand-arrow {
            color: var(--text-muted);
            text-align: center;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 28px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
        }

        .pagination button {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            cursor: pointer;
            background: var(--card-bg);
            color: var(--text-secondary);
        }

        .pagination button:hover:not(:disabled) {
            background: #F3F4F6;
        }

        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination span {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }

        .empty-state p {
            font-size: 14px;
            font-weight: 500;
        }

        .empty-state small {
            font-size: 12px;
            margin-top: 4px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
            gap: 10px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <div class="header-icon">üîç</div>
            <span class="header-title">API Log Viewer</span>
            <span id="connectionBadge" class="connection-badge connected">
                <span class="connection-dot online" id="connectionDot"></span>
                <span id="connectionText">Connected</span>
            </span>
        </div>
        <div class="header-right">
            <button class="btn btn-primary" id="autoScrollBtn" onclick="toggleAutoRefresh()">‚Üì Auto-refresh: ON</button>
            <button class="btn btn-clear" onclick="clearLogs()">üóë Clear Logs</button>
        </div>
    </div>

    <!-- TABS -->
    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('logs', this)">üìä Live Logs</button>
        <button class="tab-btn" onclick="switchTab('tester', this)">üöÄ API Tester</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 1: LIVE LOGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content active" id="tab-logs">
        <div class="stats-bar">
            <div class="stat-item"><span class="stat-label">TOTAL</span><span class="stat-value" id="statTotal">0</span>
            </div>
            <div class="stat-item"><span class="stat-label">SUCCESS</span><span class="stat-value green"
                    id="statSuccess">0</span></div>
            <div class="stat-item"><span class="stat-label">ERRORS</span><span class="stat-value red"
                    id="statErrors">0</span></div>
            <div class="stat-item"><span class="stat-label">AVG RESPONSE</span><span class="stat-value"
                    id="statAvgTime">0ms</span></div>
        </div>
        <div class="filter-bar">
            <button class="filter-btn active" onclick="setFilter('all', this)">üìã All</button>
            <button class="filter-btn" onclick="setFilter('requests', this)">üì§ Requests</button>
            <button class="filter-btn" onclick="setFilter('responses', this)">‚úì Success</button>
            <button class="filter-btn" onclick="setFilter('errors', this)">‚úï Errors</button>
        </div>
        <div class="log-list" id="logList">
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <span>Connecting to backend...</span>
            </div>
        </div>
        <div class="pagination" id="paginationBar" style="display:none;">
            <button id="prevBtn" onclick="changePage(-1)">‚Üê Previous</button>
            <span id="pageInfo">Page 1</span>
            <button id="nextBtn" onclick="changePage(1)">Next ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 2: API TESTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-tester">
        <div class="api-tester">
            <div class="tester-row">
                <select class="method-select" id="apiMethod">
                    <option value="GET">GET</option>
                    <option value="POST" selected>POST</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <input type="text" class="url-input" id="apiUrl" placeholder="/api/auth/login" value="/api/auth/login">
                <button class="send-btn" id="sendBtn" onclick="sendApiRequest()">‚ñ∂ Send</button>
            </div>

            <div style="margin-bottom: 14px;">
                <div class="body-label">Authorization Token (optional)</div>
                <input type="text" class="url-input" id="apiToken"
                    placeholder="Paste JWT token here (leave empty for public routes)" style="width:100%;">
            </div>

            <div>
                <div class="body-label">Request Body (JSON)</div>
                <textarea class="body-area" id="apiBody"
                    placeholder='{"email": "admin@example.com", "password": "yourpassword123"}'>{
  "email": "admin@example.com",
  "password": "yourpassword123"
}</textarea>
            </div>

            <!-- Response Preview -->
            <div class="response-preview" id="responsePreview" style="display:none;">
                <div class="response-header">
                    <div>
                        <span class="response-status" id="resStatus">200</span>
                        <span class="response-time-label" id="resTime"></span>
                    </div>
                    <span class="response-time-label" id="resSize"></span>
                </div>
                <pre class="response-body-preview" id="resBody"></pre>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIG ‚Äî Auto-detect: works on localhost AND live server
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const BACKEND = window.location.origin;  // e.g. http://localhost:5000 or http://buildexapi.karmadude.in
        const LOG_API = BACKEND + '/internal/logs';
        let autoRefresh = true;
        let currentFilter = 'all';
        let currentPage = 1;
        let totalPages = 1;
        let pollInterval = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TABS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function switchTab(tab, el) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            // Refresh logs when switching back to logs tab
            if (tab === 'logs') { fetchLogs(); fetchStats(); }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // API TESTER ‚Äî Send Request
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function sendApiRequest() {
            const method = document.getElementById('apiMethod').value;
            const url = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('apiToken').value.trim();
            const bodyText = document.getElementById('apiBody').value.trim();
            const sendBtn = document.getElementById('sendBtn');

            if (!url) { alert('Please enter an API endpoint'); return; }

            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥ Sending...';

            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            const options = { method, headers };
            if (['POST', 'PUT', 'PATCH'].includes(method) && bodyText) {
                try {
                    JSON.parse(bodyText); // validate
                    options.body = bodyText;
                } catch (e) {
                    alert('Invalid JSON in request body!\n' + e.message);
                    sendBtn.disabled = false;
                    sendBtn.textContent = '‚ñ∂ Send';
                    return;
                }
            }

            const startTime = performance.now();

            try {
                const res = await fetch(BACKEND + url, options);
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                const data = await res.json();

                // Show response preview
                const preview = document.getElementById('responsePreview');
                preview.style.display = 'block';

                const statusEl = document.getElementById('resStatus');
                statusEl.textContent = res.status;
                statusEl.style.background = res.status < 400 ? '#10B981' : res.status < 500 ? '#F59E0B' : '#EF4444';

                document.getElementById('resTime').textContent = `  ${duration}ms`;
                document.getElementById('resSize').textContent = JSON.stringify(data).length + ' bytes';
                document.getElementById('resBody').textContent = JSON.stringify(data, null, 2);

                // If login success, auto-fill token
                if (url.includes('/auth/login') && data.token) {
                    document.getElementById('apiToken').value = data.token;
                }
            } catch (err) {
                const preview = document.getElementById('responsePreview');
                preview.style.display = 'block';
                document.getElementById('resStatus').textContent = 'ERR';
                document.getElementById('resStatus').style.background = '#EF4444';
                document.getElementById('resTime').textContent = '';
                document.getElementById('resSize').textContent = '';
                document.getElementById('resBody').textContent = 'Network Error: ' + err.message;
            }

            sendBtn.disabled = false;
            sendBtn.textContent = '‚ñ∂ Send';

            // Refresh logs after a short delay so the new request appears
            setTimeout(() => { fetchLogs(); fetchStats(); }, 1000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOGS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function init() {
            await fetchLogs();
            await fetchStats();
            pollInterval = setInterval(pollRefresh, 5000);
        }

        async function fetchLogs() {
            try {
                let params = `?limit=50&page=${currentPage}`;
                if (currentFilter !== 'all') params += `&filter=${currentFilter}`;
                const res = await fetch(`${LOG_API}${params}`);
                const data = await res.json();
                if (data.success) {
                    totalPages = data.totalPages || 1;
                    renderLogs(data.data);
                    updatePagination();
                    setConnected(true);
                }
            } catch (err) {
                setConnected(false);
                document.getElementById('logList').innerHTML = `
                    <div class="empty-state">
                        <p>‚ö†Ô∏è Cannot connect to backend</p>
                        <small>Make sure backend is running at ${BACKEND}</small>
                    </div>`;
            }
        }

        async function pollRefresh() {
            if (!autoRefresh || currentPage !== 1) return;
            await fetchLogs();
            await fetchStats();
        }

        async function fetchStats() {
            try {
                const res = await fetch(`${LOG_API}/stats`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('statTotal').textContent = data.data.totalRequests.toLocaleString();
                    document.getElementById('statSuccess').textContent = data.data.successRequests.toLocaleString();
                    document.getElementById('statErrors').textContent = data.data.errorRequests.toLocaleString();
                    document.getElementById('statAvgTime').textContent = data.data.avgResponseTime + 'ms';
                }
            } catch (err) { }
        }

        function renderLogs(logs) {
            const container = document.getElementById('logList');
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No logs recorded yet</p>
                        <small>Use the API Tester tab to send requests, or interact with your frontend</small>
                    </div>`;
                return;
            }

            container.innerHTML = logs.map(log => {
                const methodClass = `pill-${log.method.toLowerCase()}`;
                const statusClass = getStatusClass(log.status);
                const timeClass = getTimeClass(log.responseTime);
                const isError = log.status >= 400 ? 'error-row' : '';

                // Request JSON
                const reqData = {};
                if (log.requestBody && Object.keys(log.requestBody).length > 0) {
                    reqData.body = log.requestBody;
                }
                reqData.ip = log.ip || 'unknown';
                const reqStr = JSON.stringify(reqData, null, 2);

                // Response JSON
                let resStr = 'No response body captured';
                if (log.responseBody) {
                    try { resStr = JSON.stringify(log.responseBody, null, 2); }
                    catch (e) { resStr = String(log.responseBody); }
                }

                return `
                    <div class="log-group">
                        <div class="log-row ${isError}" onclick="toggleDetails('${log._id}')">
                            <div><span class="pill pill-api">API</span></div>
                            <div><span class="pill ${methodClass}">${log.method}</span></div>
                            <div class="log-url" title="${log.url}">${log.url}</div>
                            <div style="text-align:right"><span class="status-badge ${statusClass}">${log.status}</span></div>
                            <div class="response-time ${timeClass}">${log.responseTime}ms</div>
                            <div class="timestamp">${formatTime(log.timestamp)}</div>
                            <div class="expand-arrow" id="arrow-${log._id}">‚ñº</div>
                        </div>
                        <div class="log-details" id="details-${log._id}">
                            <div class="detail-section">
                                <div class="detail-title">‚ñ≤ REQUEST</div>
                                <pre class="code-block">${escapeHtml(reqStr)}</pre>
                            </div>
                            <div class="detail-section">
                                <div class="detail-title">‚ñº RESPONSE</div>
                                <pre class="code-block">${escapeHtml(resStr)}</pre>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function toggleDetails(id) {
            const details = document.getElementById(`details-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            document.querySelectorAll('.log-details.open').forEach(el => {
                if (el.id !== `details-${id}`) {
                    el.classList.remove('open');
                    const a = document.getElementById(el.id.replace('details-', 'arrow-'));
                    if (a) a.style.transform = 'rotate(0deg)';
                }
            });
            if (details.classList.contains('open')) {
                details.classList.remove('open');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                details.classList.add('open');
                arrow.style.transform = 'rotate(180deg)';
            }
        }

        function updatePagination() {
            const bar = document.getElementById('paginationBar');
            bar.style.display = totalPages > 1 ? 'flex' : 'none';
            document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function changePage(dir) {
            currentPage = Math.max(1, Math.min(totalPages, currentPage + dir));
            fetchLogs();
        }

        function getStatusClass(s) {
            if (s < 300) return 'status-2xx';
            if (s < 400) return 'status-3xx';
            if (s < 500) return 'status-4xx';
            return 'status-5xx';
        }
        function getTimeClass(t) {
            if (t < 100) return 'time-fast';
            if (t < 500) return 'time-medium';
            return 'time-slow';
        }
        function formatTime(ts) {
            return new Date(ts).toLocaleTimeString('en-IN', {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
        }
        function setConnected(c) {
            document.getElementById('connectionBadge').className = `connection-badge ${c ? 'connected' : 'disconnected'}`;
            document.getElementById('connectionDot').className = `connection-dot ${c ? 'online' : 'offline'}`;
            document.getElementById('connectionText').textContent = c ? 'Connected' : 'Disconnected';
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = document.getElementById('autoScrollBtn');
            btn.textContent = autoRefresh ? '‚Üì Auto-refresh: ON' : '‚è∏ Auto-refresh: OFF';
            btn.className = autoRefresh ? 'btn btn-primary' : 'btn btn-primary off';
        }

        function setFilter(filter, el) {
            currentFilter = filter;
            currentPage = 1;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            fetchLogs();
        }

        async function clearLogs() {
            if (!confirm('Clear all logs?')) return;
            try {
                await fetch(LOG_API, { method: 'DELETE' });
                currentPage = 1;
                await fetchLogs();
                await fetchStats();
            } catch (err) { alert('Failed to clear logs'); }
        }

        init();
    </script>
</body>

</html>